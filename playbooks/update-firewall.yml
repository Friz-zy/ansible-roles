---
- name: Update iptables
  hosts: all
  become: yes

  roles:
    - iptables-persistent

  tasks:
    - name: Create iptables v4 rules
      copy:
        dest: /etc/iptables/rules.v4
        content: |
            # Generated by iptables-save v1.6.1 on Mon Mar 18 17:12:01 2019
            *filter
            :INPUT ACCEPT [0:0]
            :FORWARD ACCEPT [0:0]
            :OUTPUT ACCEPT [578:80264]
            -A INPUT -p tcp -m tcp --dport 53 -j ACCEPT
            -A INPUT -p udp -m udp --dport 53 -j ACCEPT
            -A INPUT -i lo -j ACCEPT
            -A INPUT -s 10.0.0.0/8 -m comment --comment local -j ACCEPT
            -A INPUT -s 100.64.0.0/10 -m comment --comment local -j ACCEPT
            -A INPUT -s 172.16.0.0/12 -m comment --comment local -j ACCEPT
            -A INPUT -s 192.168.0.0/16 -m comment --comment local -j ACCEPT
            -A INPUT -p tcp -m tcp -m multiport --dports 22,80,443 -j ACCEPT
            -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
            -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
            -A INPUT -j DROP
            COMMIT
            # Completed on Mon Mar 18 17:12:01 2019

    - name: Create iptables v6 rules
      copy:
        dest: /etc/iptables/rules.v6
        content: |
            # Generated by ip6tables-save v1.6.1 on Mon Mar 18 17:12:01 2019
            *filter
            :INPUT ACCEPT [0:0]
            :FORWARD ACCEPT [0:0]
            :OUTPUT ACCEPT [0:0]
            -A INPUT -p tcp -m tcp --dport 53 -j ACCEPT
            -A INPUT -p udp -m udp --dport 53 -j ACCEPT
            -A INPUT -i lo -j ACCEPT
            -A INPUT -s fc00::/7 -m comment --comment local -j ACCEPT
            -A INPUT -p tcp -m tcp -m multiport --dports 22,80,443 -j ACCEPT
            -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
            -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
            -A INPUT -j DROP
            COMMIT
            # Completed on Mon Mar 18 17:12:01 2019

    - name: Apply iptables rules
      shell: |
        iptables-restore < /etc/iptables/rules.v4 && \
        ip6tables-restore < /etc/iptables/rules.v6
